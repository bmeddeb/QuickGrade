{% extends "base.html" %}

{% block title %}Fetch GitHub Data - QuickGrade{% endblock %}
{% block page_id %}github-fetch{% endblock %}
{% block header_subtitle %}Fetch Data{% endblock %}

{% block content %}
<div x-data="fetchPage()" x-init="init()">
  <div class="mb-8">
    <h1 class="text-2xl font-semibold">Fetch GitHub Data</h1>
    <p class="mt-2 text-[var(--paper-muted)]">Import data from your GitHub repositories</p>
  </div>

  <!-- Upload Section -->
  <div class="grid gap-6 lg:grid-cols-2" x-show="!taskId">
    <!-- File Upload Card -->
    <div class="paper-card p-6">
      <h2 class="text-lg font-semibold mb-4">
        <i class="nc-icon nc-cloud-upload-94 mr-2"></i>
        Upload Excel File
      </h2>
      <p class="text-sm text-[var(--paper-muted)] mb-4">
        Upload an Excel file (.xlsx) with GitHub slugs in the first column (e.g., <code class="bg-[var(--paper-bg)] px-1 rounded">owner/repo</code>).
      </p>

      <div class="border-2 border-dashed border-[var(--paper-border)] rounded-lg p-8 text-center hover:border-[var(--paper-primary)] transition-colors"
           @dragover.prevent="dragOver = true"
           @dragleave.prevent="dragOver = false"
           @drop.prevent="handleFileDrop($event)"
           :class="{ 'border-[var(--paper-primary)] bg-[var(--paper-primary)]/5': dragOver }">
        <i class="nc-icon nc-cloud-upload-94 text-4xl text-[var(--paper-muted)] mb-4"></i>
        <p class="text-sm text-[var(--paper-muted)] mb-2">Drag and drop your Excel file here, or</p>
        <label class="paper-btn paper-btn-outline cursor-pointer">
          <span>Choose File</span>
          <input type="file" class="hidden" accept=".xlsx,.xls" @change="handleFileSelect($event)">
        </label>
        <p class="text-xs text-[var(--paper-muted)] mt-3" x-show="selectedFile" x-text="selectedFile?.name"></p>
      </div>
    </div>

    <!-- Text Input Card -->
    <div class="paper-card p-6">
      <h2 class="text-lg font-semibold mb-4">
        <i class="nc-icon nc-single-copy-04 mr-2"></i>
        Paste URLs
      </h2>
      <p class="text-sm text-[var(--paper-muted)] mb-4">
        Paste GitHub slugs or URLs, one per line.
      </p>

      <textarea
        x-model="urlText"
        class="w-full h-48 px-4 py-3 border border-[var(--paper-border)] rounded-lg text-sm font-mono resize-none focus:outline-none focus:border-[var(--paper-primary)] focus:ring-2 focus:ring-[var(--paper-primary)]/20"
        placeholder="owner/repo1
owner/repo2
bmeddeb/QuickGrade"></textarea>
    </div>
  </div>

  <!-- Submit Button -->
  <div class="mt-6" x-show="!taskId">
    <button
      @click="startFetch()"
      :disabled="loading || (!selectedFile && !urlText.trim())"
      class="paper-btn paper-btn-primary"
      :class="{ 'opacity-50 cursor-not-allowed': loading || (!selectedFile && !urlText.trim()) }">
      <span x-show="!loading">
        <i class="nc-icon nc-cloud-download-93 mr-2"></i>
        Start Fetch
      </span>
      <span x-show="loading">
        <i class="nc-icon nc-refresh-69 mr-2 animate-spin"></i>
        Starting...
      </span>
    </button>
  </div>

  <!-- Error Message -->
  <div x-show="error" class="mt-6 paper-card p-4 border-l-4 border-[var(--paper-danger)]">
    <p class="text-sm text-[var(--paper-danger)]" x-text="error"></p>
  </div>

  <!-- Progress Section -->
  <div x-show="taskId && status !== 'complete' && status !== 'error'" class="mt-6">
    <div class="paper-card p-6">
      <h2 class="text-lg font-semibold mb-4">
        <i class="nc-icon nc-refresh-69 mr-2 animate-spin"></i>
        Fetching Repositories
      </h2>

      <!-- Overall Progress Bar -->
      <div class="mb-6">
        <div class="flex justify-between text-sm mb-2">
          <span class="text-[var(--paper-muted)]">
            <span x-show="repoIndex > 0">Repository <span x-text="repoIndex"></span> of <span x-text="repoTotal"></span></span>
            <span x-show="repoIndex === 0">Initializing...</span>
          </span>
          <span class="font-semibold" x-text="overallProgress + '%'"></span>
        </div>
        <div class="h-3 bg-[var(--paper-border)] rounded-full overflow-hidden">
          <div class="h-full bg-[var(--paper-primary)] rounded-full transition-all duration-300"
               :style="'width: ' + overallProgress + '%'"></div>
        </div>
      </div>

      <!-- Current Repository -->
      <div class="bg-[var(--paper-bg)] rounded-lg p-4">
        <p class="text-sm font-semibold" x-text="currentRepo || 'Initializing...'"></p>
        <p class="text-xs text-[var(--paper-muted)] mt-1" x-text="currentStage"></p>
        <p class="text-xs text-[var(--paper-info)] mt-1" x-show="currentDetail" x-text="currentDetail"></p>
      </div>

      <!-- URL List -->
      <div class="mt-4 max-h-48 overflow-y-auto">
        <template x-for="url in urls" :key="url">
          <div class="flex items-center gap-2 py-2 border-b border-[var(--paper-border)] last:border-0">
            <span x-show="getUrlStatus(url) === 'pending'" class="text-[var(--paper-muted)]">
              <i class="nc-icon nc-time-alarm"></i>
            </span>
            <span x-show="getUrlStatus(url) === 'processing'" class="text-[var(--paper-primary)]">
              <i class="nc-icon nc-refresh-69 animate-spin"></i>
            </span>
            <span x-show="getUrlStatus(url) === 'done'" class="text-[var(--paper-success)]">
              <i class="nc-icon nc-check-2"></i>
            </span>
            <span x-show="getUrlStatus(url) === 'error'" class="text-[var(--paper-danger)]">
              <i class="nc-icon nc-simple-remove"></i>
            </span>
            <span class="text-sm truncate" x-text="url"></span>
          </div>
        </template>
      </div>
    </div>
  </div>

  <!-- Results Section -->
  <div x-show="status === 'complete'" class="mt-6">
    <div class="paper-card p-6">
      <h2 class="text-lg font-semibold mb-4 text-[var(--paper-success)]">
        <i class="nc-icon nc-check-2 mr-2"></i>
        Fetch Complete
      </h2>

      <!-- Summary Stats -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-[var(--paper-bg)] rounded-lg p-4 text-center">
          <p class="text-2xl font-bold text-[var(--paper-primary)]" x-text="result?.repos_processed || 0"></p>
          <p class="text-xs text-[var(--paper-muted)]">Repositories</p>
        </div>
        <div class="bg-[var(--paper-bg)] rounded-lg p-4 text-center">
          <p class="text-2xl font-bold text-[var(--paper-info)]" x-text="result?.total_commits || 0"></p>
          <p class="text-xs text-[var(--paper-muted)]">Commits</p>
        </div>
        <div class="bg-[var(--paper-bg)] rounded-lg p-4 text-center">
          <p class="text-2xl font-bold text-[var(--paper-success)]" x-text="result?.total_pull_requests || 0"></p>
          <p class="text-xs text-[var(--paper-muted)]">Pull Requests</p>
        </div>
        <div class="bg-[var(--paper-bg)] rounded-lg p-4 text-center">
          <p class="text-2xl font-bold text-[var(--paper-warning)]" x-text="result?.total_issues || 0"></p>
          <p class="text-xs text-[var(--paper-muted)]">Issues</p>
        </div>
      </div>

      <!-- Success/Failed Breakdown -->
      <div class="flex gap-4 mb-6">
        <div class="flex items-center gap-2">
          <span class="w-3 h-3 rounded-full bg-[var(--paper-success)]"></span>
          <span class="text-sm"><span x-text="result?.successful || 0"></span> successful</span>
        </div>
        <div class="flex items-center gap-2" x-show="result?.failed > 0">
          <span class="w-3 h-3 rounded-full bg-[var(--paper-danger)]"></span>
          <span class="text-sm"><span x-text="result?.failed || 0"></span> failed</span>
        </div>
      </div>

      <!-- Repository Results -->
      <div class="space-y-3 max-h-96 overflow-y-auto">
        <template x-for="repo in result?.results || []" :key="repo.repo_url">
          <div class="bg-[var(--paper-bg)] rounded-lg p-4">
            <div class="flex items-start justify-between">
              <div>
                <p class="font-semibold" x-text="repo.full_name || repo.repo_url"></p>
                <div class="flex gap-4 mt-2 text-xs text-[var(--paper-muted)]" x-show="repo.success">
                  <span><i class="fa fa-code-fork mr-1"></i><span x-text="repo.commits || 0"></span> commits</span>
                  <span><i class="fa fa-code-pull-request mr-1"></i><span x-text="repo.pull_requests || 0"></span> PRs</span>
                  <span><i class="fa fa-exclamation-circle mr-1"></i><span x-text="repo.issues || 0"></span> issues</span>
                </div>
                <p class="text-xs text-[var(--paper-danger)] mt-1" x-show="!repo.success" x-text="repo.error"></p>
              </div>
              <span x-show="repo.success" class="text-[var(--paper-success)]">
                <i class="nc-icon nc-check-2"></i>
              </span>
              <span x-show="!repo.success" class="text-[var(--paper-danger)]">
                <i class="nc-icon nc-simple-remove"></i>
              </span>
            </div>
          </div>
        </template>
      </div>

      <!-- Actions -->
      <div class="mt-6 flex gap-3">
        <a href="{% url 'github:dashboard' %}" class="paper-btn paper-btn-primary">
          <i class="nc-icon nc-chart-bar-32 mr-2"></i>
          View Dashboard
        </a>
        <button @click="resetForm()" class="paper-btn paper-btn-outline">
          <i class="nc-icon nc-refresh-69 mr-2"></i>
          Fetch More
        </button>
      </div>
    </div>
  </div>

  <!-- Error State -->
  <div x-show="status === 'error'" class="mt-6">
    <div class="paper-card p-6 border-l-4 border-[var(--paper-danger)]">
      <h2 class="text-lg font-semibold mb-2 text-[var(--paper-danger)]">
        <i class="nc-icon nc-simple-remove mr-2"></i>
        Fetch Failed
      </h2>
      <p class="text-sm text-[var(--paper-muted)]" x-text="errorMessage"></p>
      <button @click="resetForm()" class="paper-btn paper-btn-outline mt-4">
        <i class="nc-icon nc-refresh-69 mr-2"></i>
        Try Again
      </button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function fetchPage() {
  return {
    // Form state
    selectedFile: null,
    urlText: '',
    dragOver: false,
    loading: false,
    error: null,

    // Task state
    taskId: null,
    status: null,
    urls: [],
    urlStatuses: {},
    currentRepo: null,
    currentStage: null,
    currentDetail: null,
    overallProgress: 0,
    repoIndex: 0,
    repoTotal: 0,
    result: null,
    errorMessage: null,

    // EventSource for SSE
    eventSource: null,

    init() {
      // Check for existing task in URL params
      const params = new URLSearchParams(window.location.search);
      const taskId = params.get('task_id');
      if (taskId) {
        this.taskId = taskId;
        this.connectSSE();
      }
    },

    handleFileSelect(event) {
      this.selectedFile = event.target.files[0];
      this.urlText = ''; // Clear text if file selected
      this.error = null;
    },

    handleFileDrop(event) {
      this.dragOver = false;
      const file = event.dataTransfer.files[0];
      if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))) {
        this.selectedFile = file;
        this.urlText = '';
        this.error = null;
      } else {
        this.error = 'Please upload an Excel file (.xlsx or .xls)';
      }
    },

    async startFetch() {
      this.loading = true;
      this.error = null;

      try {
        const formData = new FormData();

        if (this.selectedFile) {
          formData.append('file', this.selectedFile);
        } else if (this.urlText.trim()) {
          formData.append('urls', this.urlText.trim());
        }

        const response = await fetch('{% url "github:fetch" %}', {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': this.getCookie('csrftoken'),
          }
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to start fetch');
        }

        this.taskId = data.task_id;
        this.urls = data.urls || [];
        this.urlStatuses = {};
        this.urls.forEach(url => this.urlStatuses[url] = 'pending');

        // Update URL without reload
        window.history.pushState({}, '', `?task_id=${this.taskId}`);

        // Connect to SSE for progress updates
        this.connectSSE();

      } catch (err) {
        this.error = err.message;
      } finally {
        this.loading = false;
      }
    },

    connectSSE() {
      if (this.eventSource) {
        this.eventSource.close();
      }

      this.eventSource = new EventSource(`{% url "github:fetch_progress" "TASK_ID" %}`.replace('TASK_ID', this.taskId));

      this.eventSource.onmessage = (event) => {
        const data = JSON.parse(event.data);
        this.handleProgress(data);
      };

      this.eventSource.onerror = () => {
        // Fall back to polling if SSE fails
        this.eventSource.close();
        this.pollStatus();
      };
    },

    handleProgress(data) {
      this.status = data.status;

      if (data.status === 'progress') {
        this.currentRepo = data.current_repo;
        this.currentStage = this.formatStage(data.stage);
        this.currentDetail = data.detail || null;
        this.repoIndex = data.repo_index || 0;
        this.repoTotal = data.repo_total || this.urls.length;

        // Use server-provided overall progress if available, otherwise calculate
        if (data.overall_progress) {
          this.overallProgress = data.overall_progress;
        } else {
          this.overallProgress = Math.round((data.progress_min + data.progress_max) / 2);
        }

        // Update URL status
        if (data.current_repo) {
          // Mark previous as done, current as processing
          Object.keys(this.urlStatuses).forEach(url => {
            if (url === data.current_repo) {
              this.urlStatuses[url] = 'processing';
            } else if (this.urlStatuses[url] === 'processing') {
              this.urlStatuses[url] = 'done';
            }
          });
        }
      } else if (data.status === 'complete') {
        this.result = data.result;
        this.overallProgress = 100;
        this.currentDetail = null;
        Object.keys(this.urlStatuses).forEach(url => this.urlStatuses[url] = 'done');
        if (this.eventSource) this.eventSource.close();
      } else if (data.status === 'error') {
        this.errorMessage = data.error;
        if (this.eventSource) this.eventSource.close();
      }
    },

    async pollStatus() {
      const response = await fetch(`{% url "github:task_status" "TASK_ID" %}`.replace('TASK_ID', this.taskId));
      const data = await response.json();
      this.handleProgress(data);

      if (data.status !== 'complete' && data.status !== 'error') {
        setTimeout(() => this.pollStatus(), 1000);
      }
    },

    formatStage(stage) {
      const stageNames = {
        'initializing': 'Initializing...',
        'cloning': 'Cloning repository...',
        'extracting_commits': 'Extracting commits...',
        'analyzing_code': 'Analyzing code complexity...',
        'fetching_api': 'Fetching from GitHub API...',
        'reconciling': 'Saving data...',
        'cleanup': 'Cleaning up...',
      };
      return stageNames[stage] || stage;
    },

    getUrlStatus(url) {
      return this.urlStatuses[url] || 'pending';
    },

    resetForm() {
      this.selectedFile = null;
      this.urlText = '';
      this.taskId = null;
      this.status = null;
      this.urls = [];
      this.urlStatuses = {};
      this.currentRepo = null;
      this.currentStage = null;
      this.currentDetail = null;
      this.overallProgress = 0;
      this.repoIndex = 0;
      this.repoTotal = 0;
      this.result = null;
      this.error = null;
      this.errorMessage = null;
      window.history.pushState({}, '', window.location.pathname);
    },

    getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  };
}
</script>
{% endblock %}
